<!DOCTYPE html>
<html>
    <head>
    <!-- Title -->
    
    <title>
        [iOS]安全Swift的Unsafe | Big Wolf’s Blog
    </title>
    
    <!-- Favicons -->
    <link rel="icon shortcut" type="image/ico" href="/img/favicon.png">
    <link rel="icon" sizes="192x192" href="/img/favicon.png">
    <link rel="apple-touch-icon" href="/img/favicon.png">
    
    <!-- Meta & INfo -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#FF8247">
    <meta name="author" content="与狼同行">
    <meta name="description" content="null">
    <meta name="keywords" content="null">
    
    <!--iOS -->
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-title" content="Title">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="480">
    
    <!-- Add to homescreen for Chrome on Android -->
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- Add to homescreen for Safari on iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Big Wolf’s Blog">
    
    <!-- The Open Graph protocol -->
    <meta property="og:url" content="http://chenmingjia.github.io">
    <meta property="og:type" content="blog">
    <meta property="og:title" content="[iOS]安全Swift的Unsafe | Big Wolf’s Blog">
    <meta property="og:description" content="null">
    
     <!--[if lte IE 9]>
        <link rel="stylesheet" href="/css/ie-blocker.css">
        
        
            <script src="/js/ie-blocker.zhCN.js"></script>
        
    <![endif]-->
    
    <!-- Import CSS -->
    <link rel="stylesheet" href="/css/material.min.css">
    <link rel="stylesheet" href="/css/style.min.css">
    <!-- Config CSS -->

<!-- Theme Background -->

    <style>
        body{
            background-color: #F5F5F5
        }
		
        #scheme-Paradox .material-layout .something-else .mdl-card__supporting-text{
            background-color: #fff;
        }
		
        #scheme-Paradox .MD-burger-layer {
            background-color: #666;
        }
		
        #scheme-Paradox .material-back{
            color: #666;
        }
		
        .material-layout .material-post>.material-nav,
		.material-layout .material-index>.material-nav,
        .material-nav a,
        #scheme-Paradox .material-post_container .material-back{
            color: #666;
        }
    </style>


<!-- Fade Effect -->

    <style>
        .fade {
            transition: all 800ms linear;
            -webkit-transform: translate3d(0,0,0);
            -moz-transform: translate3d(0,0,0);
            -ms-transform: translate3d(0,0,0);
            -o-transform: translate3d(0,0,0);
            transform: translate3d(0,0,0);
            opacity: 1;
        }

        .fade.out{
            opacity: 0;
        }
    </style>


<!-- Other Styles -->
<style>
	body, html{
		font-family: Roboto, "Helvetica Neue", Helvetica, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "微软雅黑", Arial, sans-serif;
	}
	
    a{
        color: #FF8C69
    }
    
    .mdl-card__media,
    #search-label,
    #search-form-label:after,
    #scheme-Paradox .hot_tags-count,
    #scheme-Paradox .sidebar_archives-count,
    #scheme-Paradox .sidebar-colored .sidebar-header,
    #scheme-Paradox .sidebar-colored .sidebar-badge{
        background-color: #FF8247 !important
    }
    
    #scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:focus{
        color: #FF8247 !important
    }
    
    #post_entry-right-info,
    .sidebar-colored .sidebar-nav li:hover > a,
    .sidebar-colored .sidebar-nav li:hover > a i,
    .sidebar-colored .sidebar-nav li > a:hover,
    .sidebar-colored .sidebar-nav li > a:hover i,
    .sidebar-colored .sidebar-nav li > a:focus i,
    .sidebar-colored .sidebar-nav > .open > a,
    .sidebar-colored .sidebar-nav > .open > a:hover,
    .sidebar-colored .sidebar-nav > .open > a:focus,
    #ds-reset #ds-ctx .ds-ctx-entry .ds-ctx-head a{
        color: #FF8247 !important
    }
    
    .fab{
        background: #FF8247 !important
    }
</style>
	<script src="/js/jquery.min.js"></script>
	
	<!-- UC Browser Compatible-->
	<script>
		var agent = navigator.userAgent.toLowerCase();
		if(agent.indexOf('ucbrowser')>0) {
			document.write('<link rel="stylesheet" href="/css/uc.css">');
		   alert('由于 UC 浏览器使用极旧的内核，而本网站使用了一些新的特性。\n为了您能更好的浏览，推荐使用 Chrome 或 Firefox 浏览器。');
		}
	</script>
    
    <!-- Custom Head -->
    
</head>
	
	

    <body id="scheme-Paradox">

		
        <div class="material-layout  mdl-js-layout has-drawer is-upgraded">
				
			
			
            <!-- Main Container -->
            <main class="material-layout__content" id="main">
				
                <!-- Top Anchor -->
                <div id="top"></div>
				
				
                <!-- Hamburger Button -->
                <button class="MD-burger-icon sidebar-toggle">
                    <span class="MD-burger-layer"></span>
                </button>
				
				
                
	<!-- Back Button -->
	<div class="material-back" id="backhome-div" tabindex="0">
		<a class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon" href="#" onclick="window.history.back();return false;" target="_self" role="button" data-upgraded=",MaterialButton,MaterialRipple">
			<i class="material-icons" role="presentation">arrow_back</i>
			<span class="mdl-button__ripple-container">
				<span class="mdl-ripple"></span>
			</span>
		</a>
	</div>			


<!-- Layouts -->

    <!-- Post Module -->
    <div class="material-post_container">
        <div class="material-post mdl-grid">
            <div class="mdl-card mdl-shadow--4dp mdl-cell mdl-cell--12-col">

                <!-- Post Header(Thumbnail & Title) -->
                
	<!-- Paradox Post Header -->
	
		<!-- Custom Thumbnail -->
		<div class="post_thumbnail-custom mdl-card__media mdl-color-text--grey-50" style="background-image:url(http://img.zcool.cn/community/0160ff5544c7ad0000019ae93f14cf.jpg)">
	
        <p class="article-headline-p">
            [iOS]安全Swift的Unsafe
        </p>
    </div>

	

				
				
					<!-- Paradox Post Info -->
					<div class="mdl-color-text--grey-700 mdl-card__supporting-text meta">
    
    <!-- Author Avatar -->
    <div id="author-avatar">
        <img src="/img/avatar.png" width="44px" height="44px" alt="Author Avatar"/>
    </div>
    <!-- Author Name & Date -->
    <div>
        <strong>与狼同行</strong>
        <span>11月 15, 2016</span>
    </div>
    
    <div class="section-spacer"></div>
	
    <!-- Favorite -->
<!--
    <button id="article-functions-like-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon btn-like">
        <i class="material-icons" role="presentation">favorite</i>
        <span class="visuallyhidden">favorites</span>
    </button>
-->
    
    <!-- Tags (bookmark) -->
    <button id="article-functions-viewtags-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
        <i class="material-icons" role="presentation">bookmark</i>
        <span class="visuallyhidden">bookmark</span>
    </button>
    <ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-functions-viewtags-button">
        <li class="mdl-menu__item">
        <a class="post_tag-link" href="/tags/iOS/">iOS</a></li><li class="mdl-menu__item"><a class="post_tag-link" href="/tags/原理篇/">原理篇</a></li><li class="mdl-menu__item"><a class="post_tag-link" href="/tags/杂项/">杂项</a>
    </ul>
    
    <!-- Share -->
    <button id="article-fuctions-share-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
    <i class="material-icons" role="presentation">share</i>
    <span class="visuallyhidden">share</span>
</button>
<ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-fuctions-share-button">
    
    
    
    
    
    <!-- Share Twitter -->
    <a class="post_share-link" href="https://twitter.com/intent/tweet?text=[iOS]安全Swift的Unsafe&url=http://chenmingjia.github.io//2016/11/15/20161018安全Swift的不安全/index.html&via=与狼同行" target="_blank">
        <li class="mdl-menu__item">
            分享到 Twitter
        </li>
    </a>
    
    <!-- Share Google+ -->
    <a class="post_share-link" href="https://plus.google.com/share?url=http://chenmingjia.github.io//2016/11/15/20161018安全Swift的不安全/index.html" target="_blank">
        <li class="mdl-menu__item">
            分享到 Google+
        </li>
    </a>
    
    <!-- Share Weibo -->
    <a class="post_share-link" href="http://service.weibo.com/share/share.php?appkey=&title=[iOS]安全Swift的Unsafe&url=http://chenmingjia.github.io//2016/11/15/20161018安全Swift的不安全/index.html&pic=&searchPic=false&style=simple" target="_blank">
        <li class="mdl-menu__item">
            分享到微博
        </li>
    </a>
</ul>
</div>
				

                <!-- Post Content -->
                <div id="post-content" class="markdown-Github mdl-color-text--grey-700 mdl-card__supporting-text fade out">
	
		<h2 id="一、介绍"><a href="#一、介绍" class="headerlink" title="一、介绍"></a>一、介绍</h2><p>Swift是一门以安全为设计理念的语言，但同时由于 Swift 的多样性的特点，你可能需要调用一个并不安全的 C 的 Api 如 OpenGL、POSIX。<br>这些Api需要你使用指针和手动在堆中申请内存空间。<br>在C中,你将会写下下面这样的代码:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">int *a = malloc(sizeof(int));</div><div class="line">*a = 42;</div><div class="line">printf(&quot;a&apos;s value: %d&quot;,*a)</div><div class="line">free(a)</div></pre></td></tr></table></figure></p>
<p>而这在 Swift 在这么实现的：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">let a = UnsafeMutablePointer&lt;Int&gt;.allocate(capacity: 1)</div><div class="line">a.pointee = 42</div><div class="line">print(&quot;a&apos;s value: \(a.pointee)&quot;) //42</div><div class="line">a.deallocate(capacity:1)</div><div class="line">print(&quot;a&apos;s value: \(a.pointee)&quot;) //无法预测</div></pre></td></tr></table></figure></p>
<p>注意!由于使用了这个Unsafe的API,在a.deallocate释放内存后，内存会被其他值写入，可能访问到随机值，而我们的指针仍然指向那块未知的内存，是十分危险的。<br>另外capacity为分配泛型实例的个数的空间。只是分配内存,但不会负责初始化。</p>
<p><strong>严格意义来说，这些并不是C语言的纯指针，而是结构体里封装一个指向内存的指针RawPointer真·指针,大小为8字节</strong></p>
<h3 id="1-1标准使用"><a href="#1-1标准使用" class="headerlink" title="1.1标准使用"></a>1.1标准使用</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">var intPtr = UnsafeMutablePointer&lt;Int&gt;.allocate(capacity: 1)</div><div class="line">intPtr.initialize(to: 10)</div><div class="line">intPtr.deinitialize()</div><div class="line">intPtr.deallocate(capacity: 1)</div><div class="line">intPtr = nil</div></pre></td></tr></table></figure>
<h2 id="二、UnsafeMutablePointer"><a href="#二、UnsafeMutablePointer" class="headerlink" title="二、UnsafeMutablePointer"></a>二、UnsafeMutablePointer</h2><h3 id="2-1开辟内存-amp-修改内存"><a href="#2-1开辟内存-amp-修改内存" class="headerlink" title="2.1开辟内存&amp;修改内存"></a>2.1开辟内存&amp;修改内存</h3><p>UnsafeMutablePointer<t> ,这普通的结构体相当于一个 T 的指针，正如你所示的，他有一个静态函数， allocate 将会开辟需要的内存空间。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">let a = UnsafeMutablePointer&lt;Int&gt;.allocate(capacity: 0)</div><div class="line">a.pointee = 42</div><div class="line">a.predecessor().pointee = 42</div><div class="line">a.successor().pointee = 42</div><div class="line">a.successor().successor().pointee = 42</div><div class="line">let s = a.successor()</div><div class="line">let p = a.predecessor()</div></pre></td></tr></table></figure></t></p>
<p>a为指向Int类型的指针,为8个字节。<br>successor()和predecessor()就像Array一样，可以指向前面和后面的8个字节的Int空间,因为Int是8个字节。<br>下面为内存空间的结果，2a即为42.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">0x1021006b8: 0x000000000000002a 0x000000000000002a</div><div class="line">0x1021006c8: 0x000000000000002a 0x000000000000002a</div><div class="line">0x1021006d8: 0x000000000000002a</div></pre></td></tr></table></figure></p>
<p>例如我们还可以用advanced来使用数组指针的其他操作,<strong>同时它也支持下标方法</strong>:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">let size = 10</div><div class="line">var a = UnsafeMutablePointer&lt;Int&gt;.allocate(capacity: size)</div><div class="line">for idx in 0..&lt;10 &#123;</div><div class="line">a.advanced(by: idx).pointee = idx</div><div class="line">&#125;</div><div class="line">a.deallocate(capacity: size)</div></pre></td></tr></table></figure></p>
<p><strong>如果我们capacity写成0，程序照常运行，但是这样很有可能会覆盖其他有用的数据，因此一样合理控制。</strong></p>
<h3 id="2-2-amp-操作–获得指针"><a href="#2-2-amp-操作–获得指针" class="headerlink" title="2.2 &amp;操作–获得指针"></a>2.2 &amp;操作–获得指针</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">func receive(mutablePointer:UnsafeMutablePointer&lt;Int&gt;)&#123;</div><div class="line">mutablePointer.pointee *= 2</div><div class="line">&#125;</div><div class="line">var a = 42</div><div class="line">receive(mutablePointer:&amp;a)</div><div class="line">print(&quot;A&apos;s value has changed in the function:\(a)&quot;) //84</div></pre></td></tr></table></figure>
<p>但是我们要知道&amp;操作在Swift中拥有限制，它只能出现在函数参数列表中。像下面这样使用,是不合法的。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">var g = &quot;string&quot;</div><div class="line">let k = &amp;g   //&apos;&amp;&apos; can only appear immediately in a call argument list</div></pre></td></tr></table></figure></p>
<h3 id="2-3-withUnsafeMutablePointer调用指针"><a href="#2-3-withUnsafeMutablePointer调用指针" class="headerlink" title="2.3 withUnsafeMutablePointer调用指针"></a>2.3 withUnsafeMutablePointer调用指针</h3><p>如何在不创建一个函数的情况下，调用指针。为了达到这种目的，我们需要使用  withUnsafeMutablePointer  ，他将会调用一个 Swift 的引用类型和一个有参数的  block  。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">var a = 42</div><div class="line">withUnsafeMutablePointer(to: &amp;a)&#123; $0.pointee *= 2&#125;</div><div class="line">print(&quot;a&apos;s value is: \(a)&quot;) //84</div></pre></td></tr></table></figure></p>
<p>下面是一个实际调用C的API的一个例子:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">var dirEnt: UnsafeMutablePointer&lt;dirent&gt;?</div><div class="line">var dp:UnsafeMutablePointer&lt;Dir&gt;?</div><div class="line"></div><div class="line">let data = &quot;.&quot;.data(using:ascii)</div><div class="line">data?.withUnsafeBytes(&#123;(ptr:UnsafePointer&lt;Int8&gt;) in</div><div class="line">dp = opendir(ptr)</div><div class="line">&#125;)</div><div class="line"></div><div class="line">repeat&#123;</div><div class="line">dirEnt = readdir(dp)</div><div class="line">if let dir = dirEnt&#123;</div><div class="line">withUnsafePointer(to:&amp;dir.pointee.d_name,&#123; ptr in</div><div class="line">let ptrStr = unsafeBitCase(ptr,to:UnsafePointer&lt;CChar&gt;.self)</div><div class="line">let name = String(cString:ptrStr)</div><div class="line">print(&quot;\(name)&quot;)</div><div class="line">&#125;)</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line">while dirEnt != nil</div></pre></td></tr></table></figure></p>
<h2 id="三、UnsafePointer"><a href="#三、UnsafePointer" class="headerlink" title="三、UnsafePointer"></a>三、UnsafePointer</h2><h3 id="3-1使用指针"><a href="#3-1使用指针" class="headerlink" title="3.1使用指针"></a>3.1使用指针</h3><p>这个 UnsafeMutablePointer 还有一个变形—— UnsafePointer ，这个类型不允许你修改指针的值，此外不可修改的 UnsafePointer 甚至没有 allocate 方法。<br><strong>只有一个创建 UnsafePointer 方法</strong>，那就是使用 &amp; 操作。当传一个 block 或者函数，你可以使用一个 &amp; 来传入一个指针。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">func receive(pointer:UnsafePointer&lt;Int&gt;)&#123;</div><div class="line">print(&quot;param value is:\(pointer.pointee)&quot;)    //42</div><div class="line">&#125;</div><div class="line">var a:Int = 42</div><div class="line">receive(pointer: &amp;a)</div></pre></td></tr></table></figure></p>
<h2 id="四、指针类型"><a href="#四、指针类型" class="headerlink" title="四、指针类型"></a>四、指针类型</h2><h3 id="4-1指针类型转换"><a href="#4-1指针类型转换" class="headerlink" title="4.1指针类型转换"></a>4.1指针类型转换</h3><p>当处理 C 的 API 的时候，你有时候需要将指向结构体的指针转换为不同的结构体。对于 C 的 API 的处理很简单（同时也是十分危险并且容易出现报错）的，就像你在 Swift 中所看到的，所有指针的类型是被固定的，这意味着一个  UnsafePointer<int>  的指针不能再用在需要  UnsafePointer<uint8>  的地方，这使得能够更好的编写出更加安全的代码，但是同样意味着你不能在你需要的时候随意转换指针类型。<br>我们可以使用 withMemoryRebound 这个我们用来将一个指针类型转换为另一个指针类型的方法。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">a.withMemoryRebound(to: UInt8.self, capacity: 1) &#123; (ptr) in</div><div class="line">print(ptr.pointee) //ptr为UnsafePointer&lt;UInt8&gt;</div><div class="line">&#125;</div></pre></td></tr></table></figure></uint8></int></p>
<h3 id="4-2Swift中的Void指针"><a href="#4-2Swift中的Void指针" class="headerlink" title="4.2Swift中的Void指针"></a>4.2Swift中的Void指针</h3><p>在 Swift 3.0 以前，你可能需要使用 UnsafePointer<void> 。然而在3.0中有一个新的类型来处理这些指针： UnsafeRawPointer 。这个结构体和不同的结构体不同，所以这意味着他不会将其中的信息绑定到任何指定的类型中，这另我们的编码过程变得很简单。为了创建一个 UnsafeRawPointer 指针，我们只需要调用它的创建函数来包裹我们所需要的那个指针。<br>如果我们想要用另外的方法，来将这个 UsafeRawPointer 的指针转化为其他类型的指针的时候，我们需要使用 withMemoryRebound 的上一个版本的方法，在这里他叫做 assumingMemoryBound 。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">let intPtr = UnsafeMutablePointer&lt;Int&gt;.allocate(capacity: 1)</div><div class="line">let voidPtr = UnsafeRawPointer(intPtr)</div><div class="line">let intPtrAgain = voidPtr.assumingMemoryBound(to: Int.self)</div></pre></td></tr></table></figure></void></p>
<h3 id="4-3修改指针的值"><a href="#4-3修改指针的值" class="headerlink" title="4.3修改指针的值"></a>4.3修改指针的值</h3><p>为了更好地完成这篇文章，在这我将介绍一些 Swift 中指针的用法。 第一个就是在使用C的API的时候使用 void<em> 方法而不是使用内存地址。通常这会发生在一个函数接受不同类型的参数，并简单的将参数打包成 void</em> 类型，就像下面这个例子一样：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">void generic_function(int value_type, void* value);</div><div class="line"></div><div class="line">generic_function(VALUE_TYPE_INT, (void *)2);</div><div class="line">struct function_data data;</div><div class="line">generic_function(VALUE_TYPE_STRUCT, (void *)&amp;data);</div></pre></td></tr></table></figure></p>
<p>如果我们想要在 Swift 中调用第一个函数，我们需要使用特别的构造函数，这会创建一个特殊的地址的。所有这些函数将不会改变允许你改变内存地址中变量的值，所以我们将会在这种情况下使用 UnsafePointer(bitPattern:)。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">generic_function(VALUE_TYPE_INT, UnsafeRawPointer(bitPattern: 2))</div><div class="line">var data = function_data()</div><div class="line">withUnsafePointer(to: &amp;data, &#123; generic_function(VALUE_TYPE_STRUCT, UnsafeRawPointer($0)) &#125; )</div></pre></td></tr></table></figure></p>
<h3 id="4-4强制转换"><a href="#4-4强制转换" class="headerlink" title="4.4强制转换"></a>4.4强制转换</h3><p>unsafeBitCast是一个极度危险的操作。文档将其描述为“将某物强制转换为和其他东西相同的比特位”。在上面我们能够安全的使用它的原因是，我们只是简单的转换不同类型的指针，并且这些指针的比特位都是相同的。这也是我们为什么必须先调用withUnsafePointer来获取UnsafePointer，然后将其转换为UnsafePointer的原因。</p>
<p>在一开始这可能会造成迷惑，特别是当处理与指针相同的类型时，比如Swift里的Int（在目前所有可用的平台，一个指针的长度是一个字符，Int的长度同样也是一个字符）。<br>比如你很容易就会犯下面的错误：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">var x: Int = 7</div><div class="line">let xPtr = unsafeBitCast(x, UnsafePointer.self)</div></pre></td></tr></table></figure></p>
<p>这段代码的意图是创造一个指针并指向x。它会给人造成误解，因为这不是一个指向x的指针，而是一个把x的值视为地址的指针，xPtr会执行0x0000000007。<br>只是这个例子中unsafeBitCast要求类型的长度相等，所以当试图转换Int8就没这么好运了。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">var x: Int8 = 7</div><div class="line">let xPtr = unsafeBitCast(x, UnsafePointer.self)</div></pre></td></tr></table></figure></p>
<p>这段代码会简单的导致unsafeBitCast抛出异常和程序崩溃。<br><strong>另外切记不要使用unsafeBitCast做出转换同类指针的操作，比如 UnsafePointer<int>和 UnsafePointer<uint8></uint8></int></strong></p>
<h2 id="五、另一个数组指针"><a href="#五、另一个数组指针" class="headerlink" title="五、另一个数组指针"></a>五、另一个数组指针</h2><h3 id="5-1"><a href="#5-1" class="headerlink" title="5.1"></a>5.1</h3><p>Swift 还有一个 UnsafeBufferPointer 的结构体来更方便的实现这个需求。这个结构体是一个Swift数组和指针的桥梁。如果我们使用 UnsafePointer 来作为变量从而调用创建函数创建一个 UnsafeBufferPointer ，我们将能够使用大多数的Swift原生的数组（Array）方法，因为 UnsafeBufferPointer 遵守并实现了 Collections ， Indexable 和 RandomAccessCollection 协议。所以我们可以像这样遍历内存：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">// Using a and size from previous code </div><div class="line">var b = UnsafeBufferPointer(start: a, count: size)</div><div class="line">b.forEach(&#123;</div><div class="line">print(&quot;\($0)&quot; // Prints 0 to 9 that we fill previously </div><div class="line">)&#125;)</div></pre></td></tr></table></figure></p>
<p>当我们提到 UnsafeBufferPointer 的是一个Swift中数组的桥梁的时候，这也意味着我们很容易使用 UnsafeBufferPointer 来调用一个已经存在的数组，比如说下面这个例子：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">var a = [1, 2, 3, 4, 5, 6]</div><div class="line">a.withUnsafeBufferPointer(&#123; ptr in</div><div class="line">ptr.forEach(&#123; print(&quot;\($0)&quot;) &#125;) // 1, 2, 3... </div><div class="line">&#125;)</div></pre></td></tr></table></figure></p>
<h3 id="5-2-一些属性"><a href="#5-2-一些属性" class="headerlink" title="5.2 一些属性"></a>5.2 一些属性</h3><p><strong>baseAddress 是第一个元素的指针</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">var array = [1, 2, 3, 4, 5]</div><div class="line">var arrayPtr = UnsafeMutableBufferPointer&lt;Int&gt;(start: &amp;array, count: array.count)</div><div class="line">// baseAddress 是第一个元素的指针</div><div class="line">var basePtr = arrayPtr.baseAddress! as UnsafeMutablePointer&lt;Int&gt;</div></pre></td></tr></table></figure></p>
<h2 id="六、Unsafe带来的破坏"><a href="#六、Unsafe带来的破坏" class="headerlink" title="六、Unsafe带来的破坏"></a>六、Unsafe带来的破坏</h2><p><strong> 1.  第一点之前已经提到，它很有可能会覆盖我们在堆上的其他数据</strong><br><strong> 2. 这个指针指向的对象很有可能已经被释放，然而Unsafe指针本身不会涉及引用计数，因为它更接近C指针的使用。</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">var collectionPtr: UnsafeMutableBufferPointer&lt;Int&gt;?</div><div class="line">func duplicateElements(inArray: UnsafeMutableBufferPointer&lt;Int&gt;) &#123;</div><div class="line">for i in 0..&lt;inArray.count &#123;</div><div class="line">inArray[i] *= 2</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line">repeat &#123;</div><div class="line">var collection = [1, 2, 3]</div><div class="line">collection.withUnsafeMutableBufferPointer(&#123; collectionPtr = $0 &#125;)</div><div class="line">&#125; while false</div><div class="line">duplicateElements(inArray: collectionPtr!) // Crash due to EXC_BAD_ACCESS</div></pre></td></tr></table></figure></p>
<p><strong>3. 如果我们手动创建的内存没有析构,那就是内存泄漏</strong><br><strong>4. 即使指针析构以后，但没有置空，仍然会访问未知内存</strong></p>
<h3 id="七、透明指针"><a href="#七、透明指针" class="headerlink" title="七、透明指针"></a>七、透明指针</h3><p>正如这篇文章中的其他例子中所看到的。然而正如我们所看到的，这些调用在内当我们传入一个指针到 C 中来指向一个我们没有 retain 的变量的时候，这个对象将被释放，同时这个程序将会崩溃。</p>
<p>Swift 有一个实用的方法决定指向这个对象的指针是否进行 retain 。这就是 Unmanaged。使用它的 passRetained() 我们将会创建一个被 retained 的指向这个对象的指针，那么我们就能保证当他在 C 中被调用的时候他仍旧在那。当这个对象已经在回调函数中被 retianed 的时候我们可以使用 passUnretained() 。这两个方法将会产生 Unmanaged 的实例变量，这个实力变量将会通过调用 toOpaque() 方法转换为 UnsafeRawPointer。<br>在另一方面我们可以将 UnsafeRawPointer 通过相反的 API fromOpaque() 和 takeRetained() 转换为一个类或者结构体<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">void set_callback(void (*functionPtr)(void*), void* userData));</div></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">class CallbackUserData &#123;</div><div class="line">func sayHello() &#123; print(&quot;Hello world!&quot; ) &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">func callback(userData: UnsafeMutableRawPointer) &#123;</div><div class="line">let callbackUserData:CallbackUserData = Unmanaged.fromOpaque(userData).takeRetainedValue()</div><div class="line"></div><div class="line">callbackUserData.sayHello() // &quot;Hello world!&quot;</div><div class="line">&#125;</div><div class="line"></div><div class="line">var userData = CallbackUserData()</div><div class="line">let reference = Unmanaged.passRetained(userData).toOpaque()  //引用计数+1</div><div class="line">set_callback(callback, reference)</div></pre></td></tr></table></figure>

	
	
	
	
</div>
				
				

                <!-- Post Comments -->
                
    <!-- 使用多说评论 -->
    <link rel="stylesheet" href="/css/duoshuo.min.css">
<style>
    #ds-thread #ds-reset .ds-post-button{
        background-color: #FF8247 !important;
    }
    #ds-wrapper #ds-reset .ds-icons-32{
        background-color: #FF8247 !important;
    }
    #ds-reset .ds-highlight {
        color: #FF8247 !important;
    }
</style>
<div id="comments">
    <!-- 多说评论框 start -->
        <div class="ds-thread" data-thread-key="undefined" data-title="[iOS]安全Swift的Unsafe" data-url="http://chenmingjia.github.io//2016/11/15/20161018安全Swift的不安全/index.html"></div>
    <!-- 多说评论框 end -->
</div>



            </div>

            <!-- Post Prev & Next Nav -->
            <nav class="material-nav mdl-color-text--grey-50 mdl-cell mdl-cell--12-col">
    
    <!-- Prev Nav -->
    
        <a href="/2016/11/15/unitsquare/" id="post_nav-newer" class="prev-content">
            <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                <i class="material-icons">arrow_back</i>
            </button>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            新篇
        </a>
    

    <!-- Section Spacer -->
    <div class="section-spacer"></div>

    <!-- Next Nav -->
    
        <a href="/2016/11/15/20161018安全Swift的不安全的副本/" id="post_nav-older" class="next-content">
            旧篇
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                <i class="material-icons">arrow_forward</i>
            </button>
        </a>
    
</nav>
        </div>
    </div>

				
				
					<!-- Overlay For Active Sidebar -->
<div class="sidebar-overlay "></div>

<!-- Material sidebar -->
<aside id="sidebar" class="sidebar sidebar-colored  sidebar-fixed-left" role="navigation">
	<div id="sidebar-main">
	    <!-- Sidebar Header -->
		<div class="sidebar-header header-cover" style="background-image: url(/img/sidebar_header.png);">
    <!-- Top bar -->
    <div class="top-bar"></div>

    <!-- Sidebar toggle button -->
    <button type="button" class="sidebar-toggle mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon" style="display: initial;" data-upgraded=",MaterialButton,MaterialRipple">
    <i class="material-icons">clear_all</i>
    <span class="mdl-button__ripple-container"><span class="mdl-ripple"></span></span></button>

    <!-- Sidebar Avatar -->
    <div class="sidebar-image">
        <img src="/img/avatar.png" alt="与狼同行's avatar">
    </div>

    <!-- Sidebar Email -->
    <a data-toggle="dropdown" class="sidebar-brand" href="#settings-dropdown">
        youremail@email.com
        <b class="caret"></b>
    </a>
</div>

		<!-- Sidebar Navigation  -->
		<ul class="nav sidebar-nav">
    <!-- User dropdown  -->
    <li class="dropdown">
        <ul id="settings-dropdown" class="dropdown-menu">
			
                <li>
                    <a href="#" target="_blank" title="Email Me">
						<i class="material-icons sidebar-material-icons sidebar-indent-left1pc-element">email</i>
                        Email Me
                    </a>
                </li>
            
        </ul>
    </li>

    <!-- Homepage -->
    <li id="sidebar-first-li">
        <a href="/" target="_self">
            <i class="material-icons sidebar-material-icons">home</i>
             主页
        </a>
    </li>

    <!-- I'm Feeling Lucky -->
<!--
    <li class="dropdown">
        <a href="" target="_self">
            <i class="material-icons sidebar-material-icons">explore</i>
             sidebar.imlucky
        </a>
    </li>
-->

	
    <!-- Archives  -->
    <li class="dropdown">
        <a href="#" class="ripple-effect dropdown-toggle" data-toggle="dropdown">
            <i class="material-icons sidebar-material-icons">inbox</i>
             归档
            <b class="caret"></b>
        </a>
        <ul class="dropdown-menu">
            <li>
            <a class="sidebar_archives-link" href="/archives/2016/11/">十一月 2016<span class="sidebar_archives-count">17</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/10/">十月 2016<span class="sidebar_archives-count">1</span></a>
        </ul>
    </li>

    <!-- Divider -->
    <li class="divider"></li>


    <!-- Pages  -->
	
	
	
		<li>
			<a href="/about" title="关于博主">
				关于博主
			</a>
		</li>
	
		<li>
			<a href="/links/" title="友情链接">
				友情链接
			</a>
		</li>
	
		<li>
			<a href="/timeline/" title="时间轴归档">
				时间轴归档
			</a>
		</li>
	
		<li>
			<a href="/gallery/" title="图库">
				图库
			</a>
		</li>
	
		<li>
			<a href="/tags/" title="标签云">
				标签云
			</a>
		</li>
	

    <!-- Article Numebr  -->
    <li>
        <a href="#">
             文章总数
             <span class="sidebar-badge">18</span>
        </a>
    </li>
</ul>

		<!-- Sidebar Divider -->
		<div class="sidebar-divider"></div>

		<!-- Sidebar Footer -->
		<!-- 
I'm glad you use this theme, the development is no so easy, I hope you can keep the copyright, I will thank you so much.
If you still want to delete the copyrights, could you still retain the first one? Which namely "Theme Material"
It will not impact the appearance and can give developers a lot of support :)

很高兴您使用并喜欢该主题，开发不易 十分谢谢与希望您可以保留一下版权声明。
如果您仍然想删除的话 能否只保留第一项呢？即 "Theme Material"
它不会影响美观并可以给开发者很大的支持。 :) 
-->

<!-- Theme Material -->
<a href="https://github.com/viosey/hexo-theme-material"  class="sidebar-footer-text-a" target="_blank">
	<div class="sidebar-text mdl-button mdl-js-button mdl-js-ripple-effect sidebar-footer-text-div" data-upgraded=",MaterialButton,MaterialRipple">
		主题 - Material
		<span class="sidebar-badge badge-circle">i</span>
	</div>
</a>

<!-- Help & Support -->
<!--
<a href="mailto:hiviosey@gmail.com" class="sidebar-footer-text-a">
    <div class="sidebar-text mdl-button mdl-js-button mdl-js-ripple-effect sidebar-footer-text-div" data-upgraded=",MaterialButton,MaterialRipple">
		sidebar.help
		<span class="mdl-button__ripple-container">
			<span class="mdl-ripple"></span>
		</span>
	</div>
</a>
-->

<!-- Feedback -->
<!--
<a href="https://github.com/viosey/hexo-theme-material/issues" target="_blank" class="sidebar-footer-text-a">
    <div class="sidebar-text mdl-button mdl-js-button mdl-js-ripple-effect sidebar-footer-text-div" data-upgraded=",MaterialButton,MaterialRipple">
         sidebar.feedback
                    <span class="mdl-button__ripple-container"><span class="mdl-ripple"></span></span></div>
</a>
-->

<!-- Abount Theme -->
<!--
<a href="https://blog.viosey.com/index.php/Material.html" target="_blank" class="sidebar-footer-text-a">
    <div class="sidebar-text mdl-button mdl-js-button mdl-js-ripple-effect sidebar-footer-text-div" data-upgraded=",MaterialButton,MaterialRipple">
         sidebar.about_theme
        <span class="mdl-button__ripple-container"><span class="mdl-ripple"></span></span></div>
</a>-->

	</div>
    
    <!-- Sidebar Sponsor -->
    


</aside>

				
				
				<!-- Floating Action Button -->
<div class="fabs">
    <a href="#top" class="fab toTop">
        <i class="material-icons">expand_less</i>
    </a>
    
    
        <!-- Post Nav -->
        
            <a class="prev-content fab" href="/2016/11/15/unitsquare/" title="[iOS]深入理解并发--GCD(上)"><i class="material-icons">keyboard_arrow_left</i></a>
        

        
            <a class="prev-content fab" href="/2016/11/15/20161018安全Swift的不安全的副本/" title="[Math]程序员的数学整理(1)"><i class="material-icons">keyboard_arrow_right</i></a>
        
    
    
    
    
    <a href="#bottom" class="fab toBottom">
        <i class="material-icons">keyboard_arrow_down</i>
    </a>
    
    <a id="prime" class="fab">
        <i class="material-icons prime-i-add">add</i>
    </a>
</div>
				
				<!--Footer-->
<footer class="mdl-mini-footer" id="bottom">
	
	
		<!-- Paradox Footer Left Section -->
		<div class="mdl-mini-footer--left-section sns-list">
    <!-- Twitter -->
    
    
    
    <!-- Facebook -->
    
    
    
    <!-- Google + -->
    
    
    
    <!-- Weibo -->
    
    
    
    <!-- Instagram -->
    
    
    
    <!-- Tumblr -->
    
    
    
    <!-- Github -->
    
    <a href="https://www.github.com/chenmingjia" target="view_window"><button class="mdl-mini-footer--social-btn social-btn" style="background-image: url(/img/footer/footer_ico-github.png);">
        <span class="visuallyhidden">Github</span>
    </button></a>
    
</div>


		<!--Copyright-->
		<div id="copyright">Copyright&nbsp;©&nbsp;<script type="text/javascript">var fd = new Date();document.write(fd.getFullYear());</script>&nbsp;Big Wolf’s Blog</div>

		<!-- Paradox Footer Right Section -->

		<!-- 
		I'm glad you use this theme, the development is no so easy, I hope you can keep the copyright.
		It will not impact the appearance and can give developers a lot of support :)

		很高兴您使用该主题，开发不易，希望您可以保留一下版权声明。
		它不会影响美观并可以给开发者很大的支持。 :) 
		-->

		<div class="mdl-mini-footer--right-section">
			<div>
				<div class="footer-develop-div">Powered by <a href="https://hexo.io" target="_blank" class="footer-develop-a">Hexo</a></div>
				<div class="footer-develop-div">Theme - <a href="https://github.com/viosey/hexo-theme-material" target="_blank" class="footer-develop-a">Material</a></div>
			</div>
		</div>
	
    
</footer>
                
				<!-- Import File -->
<script src="/js/js.min.js"></script>
<script src="/js/nprogress.js"></script>

<script type="text/javascript">
    NProgress.configure({
        showSpinner: true
    });
    NProgress.start();
    
    $('#nprogress .bar').css({
        'background': '#FF8247'
    });
    $('#nprogress .peg').css({
        'box-shadow': '0 0 10px #FF8247, 0 0 15px #FF8247'
    });
    $('#nprogress .spinner-icon').css({
        'border-top-color': '#FF8247',
        'border-left-color': '#FF8247'
    });
    
    setTimeout(function() {
        NProgress.done();
        $('.fade').removeClass('out');
    }, 800);
</script>








    <!-- 多说公共 js 代码 start -->
    <script type="text/javascript">
    var duoshuoQuery = {short_name:"2231132"};
        (function() {
            var ds = document.createElement('script');
            ds.type = 'text/javascript';ds.async = true;
            ds.src = 'https://static.duoshuo.com/embed.js';
            ds.charset = 'UTF-8';
            (document.getElementsByTagName('head')[0] 
             || document.getElementsByTagName('body')[0]).appendChild(ds);
        })();
    </script>
    <!-- 多说公共 js 代码 end -->







	<script>
	var searchFunc = function(path, search_id, content_id) {
    'use strict';
    $.ajax({
        url: path,
        dataType: "xml",
        success: function( xmlResponse ) {
            // get the contents from search data
            var datas = $( "entry", xmlResponse ).map(function() {
                return {
                    title: $( "title", this ).text(),
                    content: $("content",this).text(),
                    url: $( "url" , this).text()
                };
            }).get();
            var $input = document.getElementById(search_id);
            var $resultContent = document.getElementById(content_id);
            $input.addEventListener('input', function(){
                var str='<ul class=\"search-result-list\">';                
                var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                $resultContent.innerHTML = "";
                if (this.value.trim().length <= 0) {
                    return;
                }
                // perform local searching
                datas.forEach(function(data) {
                    var isMatch = true;
                    var content_index = [];
                    var data_title = data.title.trim().toLowerCase();
                    var data_content = data.content.trim().replace(/<[^>]+>/g,"").toLowerCase();
                    var data_url = data.url;
                    var index_title = -1;
                    var index_content = -1;
                    var first_occur = -1;
                    // only match artiles with not empty titles and contents
                    if(data_title != '' && data_content != '') {
                        keywords.forEach(function(keyword, i) {
                            index_title = data_title.indexOf(keyword);
                            index_content = data_content.indexOf(keyword);
                            if( index_title < 0 && index_content < 0 ){
                                isMatch = false;
                            } else {
                                if (index_content < 0) {
                                    index_content = 0;
                                }
                                if (i == 0) {
                                    first_occur = index_content;
                                }
                            }
                        });
                    }
                    // show search results
                    if (isMatch) {
                        str += "<li><a href='"+ data_url +"' class='search-result-title' target='_blank'>"+ data_title;
                        var content = data.content.trim().replace(/<[^>]+>/g,"");
                        if (first_occur >= 0) {
                            // cut out characters
                            var start = first_occur - 6;
                            var end = first_occur + 6;
                            if(start < 0){
                                start = 0;
                            }
                            if(start == 0){
                                end = 10;
                            }
                            if(end > content.length){
                                end = content.length;
                            }
                            var match_content = content.substr(start, end); 
                            // highlight all keywords
                            keywords.forEach(function(keyword){
                                var regS = new RegExp(keyword, "gi");
                                match_content = match_content.replace(regS, "<em class=\"search-keyword\">"+keyword+"</em>");
                            })
                            str += "<p class=\"search-result\">" + match_content +"...</p>" +"</a>";
                        }
                    }
                })
                $resultContent.innerHTML = str;
            })
        }
    })
}
</script>

	<script>
		var search_path = "search.xml";
		if (search_path.length == 0) {
		search_path = "search.xml";
		}
		var path = "/" + search_path;
		searchFunc(path, 'search', 'local-search-result');
	</script>






            </main>
        </div>
		
    </body>
		
	
</html>
