<!DOCTYPE html>
<html>
    <head>
    <!-- Title -->
    
    <title>
        [译]使用幽灵类型的Measurements和Units ，第四部分 | Big Wolf’s Blog
    </title>
    
    <!-- Favicons -->
    <link rel="icon shortcut" type="image/ico" href="/img/favicon.png">
    <link rel="icon" sizes="192x192" href="/img/favicon.png">
    <link rel="apple-touch-icon" href="/img/favicon.png">
    
    <!-- Meta & INfo -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#FF8247">
    <meta name="author" content="与狼同行">
    <meta name="description" content="null">
    <meta name="keywords" content="null">
    
    <!--iOS -->
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-title" content="Title">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="480">
    
    <!-- Add to homescreen for Chrome on Android -->
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- Add to homescreen for Safari on iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Big Wolf’s Blog">
    
    <!-- The Open Graph protocol -->
    <meta property="og:url" content="http://chenmingjia.github.io">
    <meta property="og:type" content="blog">
    <meta property="og:title" content="[译]使用幽灵类型的Measurements和Units ，第四部分 | Big Wolf’s Blog">
    <meta property="og:description" content="null">
    
     <!--[if lte IE 9]>
        <link rel="stylesheet" href="/css/ie-blocker.css">
        
        
            <script src="/js/ie-blocker.zhCN.js"></script>
        
    <![endif]-->
    
    <!-- Import CSS -->
    <link rel="stylesheet" href="/css/material.min.css">
    <link rel="stylesheet" href="/css/style.min.css">
    <!-- Config CSS -->

<!-- Theme Background -->

    <style>
        body{
            background-color: #F5F5F5
        }
		
        #scheme-Paradox .material-layout .something-else .mdl-card__supporting-text{
            background-color: #fff;
        }
		
        #scheme-Paradox .MD-burger-layer {
            background-color: #666;
        }
		
        #scheme-Paradox .material-back{
            color: #666;
        }
		
        .material-layout .material-post>.material-nav,
		.material-layout .material-index>.material-nav,
        .material-nav a,
        #scheme-Paradox .material-post_container .material-back{
            color: #666;
        }
    </style>


<!-- Fade Effect -->

    <style>
        .fade {
            transition: all 800ms linear;
            -webkit-transform: translate3d(0,0,0);
            -moz-transform: translate3d(0,0,0);
            -ms-transform: translate3d(0,0,0);
            -o-transform: translate3d(0,0,0);
            transform: translate3d(0,0,0);
            opacity: 1;
        }

        .fade.out{
            opacity: 0;
        }
    </style>


<!-- Other Styles -->
<style>
	body, html{
		font-family: Roboto, "Helvetica Neue", Helvetica, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "微软雅黑", Arial, sans-serif;
	}
	
    a{
        color: #FF8C69
    }
    
    .mdl-card__media,
    #search-label,
    #search-form-label:after,
    #scheme-Paradox .hot_tags-count,
    #scheme-Paradox .sidebar_archives-count,
    #scheme-Paradox .sidebar-colored .sidebar-header,
    #scheme-Paradox .sidebar-colored .sidebar-badge{
        background-color: #FF8247 !important
    }
    
    #scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:focus{
        color: #FF8247 !important
    }
    
    #post_entry-right-info,
    .sidebar-colored .sidebar-nav li:hover > a,
    .sidebar-colored .sidebar-nav li:hover > a i,
    .sidebar-colored .sidebar-nav li > a:hover,
    .sidebar-colored .sidebar-nav li > a:hover i,
    .sidebar-colored .sidebar-nav li > a:focus i,
    .sidebar-colored .sidebar-nav > .open > a,
    .sidebar-colored .sidebar-nav > .open > a:hover,
    .sidebar-colored .sidebar-nav > .open > a:focus,
    #ds-reset #ds-ctx .ds-ctx-entry .ds-ctx-head a{
        color: #FF8247 !important
    }
    
    .fab{
        background: #FF8247 !important
    }
</style>
	<script src="/js/jquery.min.js"></script>
	
	<!-- UC Browser Compatible-->
	<script>
		var agent = navigator.userAgent.toLowerCase();
		if(agent.indexOf('ucbrowser')>0) {
			document.write('<link rel="stylesheet" href="/css/uc.css">');
		   alert('由于 UC 浏览器使用极旧的内核，而本网站使用了一些新的特性。\n为了您能更好的浏览，推荐使用 Chrome 或 Firefox 浏览器。');
		}
	</script>
    
    <!-- Custom Head -->
    
</head>
	
	

    <body id="scheme-Paradox">

		
        <div class="material-layout  mdl-js-layout has-drawer is-upgraded">
				
			
			
            <!-- Main Container -->
            <main class="material-layout__content" id="main">
				
                <!-- Top Anchor -->
                <div id="top"></div>
				
				
                <!-- Hamburger Button -->
                <button class="MD-burger-icon sidebar-toggle">
                    <span class="MD-burger-layer"></span>
                </button>
				
				
                
	<!-- Back Button -->
	<div class="material-back" id="backhome-div" tabindex="0">
		<a class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon" href="#" onclick="window.history.back();return false;" target="_self" role="button" data-upgraded=",MaterialButton,MaterialRipple">
			<i class="material-icons" role="presentation">arrow_back</i>
			<span class="mdl-button__ripple-container">
				<span class="mdl-ripple"></span>
			</span>
		</a>
	</div>			


<!-- Layouts -->

    <!-- Post Module -->
    <div class="material-post_container">
        <div class="material-post mdl-grid">
            <div class="mdl-card mdl-shadow--4dp mdl-cell mdl-cell--12-col">

                <!-- Post Header(Thumbnail & Title) -->
                
	<!-- Paradox Post Header -->
	
		<!-- Custom Thumbnail -->
		<div class="post_thumbnail-custom mdl-card__media mdl-color-text--grey-50" style="background-image:url(http://www.pptba.cn/news/wp-content/uploads/2016/05/aff4870209aad651.jpg)">
	
        <p class="article-headline-p">
            [译]使用幽灵类型的Measurements和Units ，第四部分
        </p>
    </div>

	

				
				
					<!-- Paradox Post Info -->
					<div class="mdl-color-text--grey-700 mdl-card__supporting-text meta">
    
    <!-- Author Avatar -->
    <div id="author-avatar">
        <img src="/img/avatar.png" width="44px" height="44px" alt="Author Avatar"/>
    </div>
    <!-- Author Name & Date -->
    <div>
        <strong>与狼同行</strong>
        <span>10月 18, 2016</span>
    </div>
    
    <div class="section-spacer"></div>
	
    <!-- Favorite -->
<!--
    <button id="article-functions-like-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon btn-like">
        <i class="material-icons" role="presentation">favorite</i>
        <span class="visuallyhidden">favorites</span>
    </button>
-->
    
    <!-- Tags (bookmark) -->
    <button id="article-functions-viewtags-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
        <i class="material-icons" role="presentation">bookmark</i>
        <span class="visuallyhidden">bookmark</span>
    </button>
    <ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-functions-viewtags-button">
        <li class="mdl-menu__item">
        <a class="post_tag-link" href="/tags/Swift/">Swift</a></li><li class="mdl-menu__item"><a class="post_tag-link" href="/tags/iOS/">iOS</a></li><li class="mdl-menu__item"><a class="post_tag-link" href="/tags/翻译/">翻译</a>
    </ul>
    
    <!-- Share -->
    <button id="article-fuctions-share-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
    <i class="material-icons" role="presentation">share</i>
    <span class="visuallyhidden">share</span>
</button>
<ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-fuctions-share-button">
    
    
    
    
    
    <!-- Share Twitter -->
    <a class="post_share-link" href="https://twitter.com/intent/tweet?text=[译]使用幽灵类型的Measurements和Units ，第四部分&url=http://chenmingjia.github.io//2016/10/18/unitsquare/index.html&via=与狼同行" target="_blank">
        <li class="mdl-menu__item">
            分享到 Twitter
        </li>
    </a>
    
    <!-- Share Google+ -->
    <a class="post_share-link" href="https://plus.google.com/share?url=http://chenmingjia.github.io//2016/10/18/unitsquare/index.html" target="_blank">
        <li class="mdl-menu__item">
            分享到 Google+
        </li>
    </a>
    
    <!-- Share Weibo -->
    <a class="post_share-link" href="http://service.weibo.com/share/share.php?appkey=&title=[译]使用幽灵类型的Measurements和Units ，第四部分&url=http://chenmingjia.github.io//2016/10/18/unitsquare/index.html&pic=&searchPic=false&style=simple" target="_blank">
        <li class="mdl-menu__item">
            分享到微博
        </li>
    </a>
</ul>
</div>
				

                <!-- Post Content -->
                <div id="post-content" class="markdown-Github mdl-color-text--grey-700 mdl-card__supporting-text fade out">
	
		<p>原文链接=<a href="https://oleb.net/blog/2016/08/measurements-and-units-with-phantom-types/" target="_blank" rel="external">https://oleb.net/blog/2016/08/measurements-and-units-with-phantom-types/</a><br>作者=Ole Begemann<br>译者=与狼同行</p>
<!--此处开始正文-->
<p>本系列其他文章：</p>
<p>(1) <a href="http://oleb.net/blog/2016/07/measurements-and-units/" target="_blank" rel="external">Measurements 和 Units 概览</a><br>(2) <a href="http://oleb.net/blog/2016/07/unitproduct/" target="_blank" rel="external">乘法和除法</a><br>(3) <a href="http://swift.gg/2016/09/29/unitsquare/" target="_blank" rel="external">内容提炼</a><br>(4) 幽灵类型(本文)</p>
<p>我之前撰写了关于标准库里新的度量值的短系列，此文是该系列的额外之作。虽然我很喜欢苹果的 API ，但我觉得探索同一问题的不同解决方案也很有意思。特别是这个问题，纯 Swift 设计是否能优于苹果的接口呢，因为苹果的接口考虑了 Objective-C 的<a href="https://lists.swift.org/pipermail/swift-corelibs-dev/Week-of-Mon-20160808/000864.html" target="_blank" rel="external">兼容性问题</a>。</p>
<a id="more"></a>
<h2 id="苹果的设计"><a href="#苹果的设计" class="headerlink" title="苹果的设计"></a>苹果的设计</h2><p>在苹果的 API 中，开发者主要使用的数据类型是<a href="https://developer.apple.com/reference/foundation/nsmeasurement" target="_blank" rel="external">度量值 <code>Measurement</code> 类型</a>，它包含一个浮点数  <code>value</code> 和用于测值的单位 <code>unit</code> ，并基于单位类型使用了泛型。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">struct Measurement&lt;UnitType: Unit&gt; &#123;</div><div class="line">let unit: UnitType</div><div class="line">var value: Double</div><div class="line">&#125;</div><div class="line"></div><div class="line">let length = Measurement(value: 5， unit: UnitLength.meters)</div><div class="line">// 长度表现为一个 Measurement&lt;UnitLength&gt;</div></pre></td></tr></table></figure>
<p>Measurement 被视为<a href="https://github.com/apple/swift-evolution/blob/master/proposals/0069-swift-mutability-for-foundation.md" target="_blank" rel="external">值类型</a>——它在 Objective-C 中是类，在 Swift 中是结构体。<br>在单位族（Unit Family）中，比如说长度或时长，被建模为类层次结构中的类型:  <a href="https://developer.apple.com/reference/foundation/nsunit" target="_blank" rel="external">Unit</a> &gt; <a href="https://developer.apple.com/reference/foundation/nsdimension" target="_blank" rel="external">Dimension</a> &gt; <a href="https://developer.apple.com/reference/foundation/nsunitlength" target="_blank" rel="external">UnitLength</a> 、 <a href="https://developer.apple.com/reference/foundation/nsunitduration" target="_blank" rel="external">UnitDuration</a>等等。具体的类型如米、千克，分别是它们单位族类的实例。每一个单位都是由单位的符号（如「kg」）和一个 <a href="https://developer.apple.com/reference/foundation/unitconverter" target="_blank" rel="external">单元转换</a>对象组成，该对象通过编码指令来使单位转化为该单位族的基本单位。</p>
<h2 id="幽灵类型"><a href="#幽灵类型" class="headerlink" title="幽灵类型"></a>幽灵类型</h2><p>如果我们将具体的单位视为一个类型而不是实例呢？假设有一些类型名为米（Meters）、千米（Kilometers），或者英里（Miles），我们可以设计一个泛型的 <code>Measurement</code> 类型，它只有一个存储属性来存放量值，该量值的单位可以被完整编码在自身类型中。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">struct MyMeasurement&lt;UnitType: MyUnit&gt; &#123;</div><div class="line">var value: Double</div><div class="line"></div><div class="line">init(_ value: Double) &#123;</div><div class="line">self.value = value</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">let length = MyMeasurement&lt;Meters&gt;(5)</div><div class="line">// length is a MyMeasurement&lt;Meters&gt;</div></pre></td></tr></table></figure></p>
<p>现在我们再次审视两种方式的不同之处，苹果的设计是让单位族 <code>length</code>作为 <code>Measurement</code> 的参数，让具体的单位 米 作为该值的一部分。而我的设计是让具体的单位 米 成为泛型参数。<br><code>MyMeasurement</code> 也能被称为<a href="https://wiki.haskell.org/Phantom_type" target="_blank" rel="external">幽灵类型</a>，因为泛型参数 UnitType 没有在类型声明中出现。它的用途仅仅是用于相互区分类似 <code>MyMeasurement &lt;Meters&gt;</code> 和 <code>MyMeasurement &lt;Kilometers&gt;</code> 这样的类型，这样它们就无法互相替换。<br>我们之后将看看这样设计是否真的有用，因为你可能会争辩，用米的度量值应当能与用千米的度量值互相转换。想了解更多关于 Swift 中幽灵类型的例子，可以看 <a href="https://www.objc.io/blog/2014/12/29/functional-snippet-13-phantom-types/" target="_blank" rel="external">objc.org</a> 的文章或 <a href="https://realm.io/news/swift-summit-johannes-weiss-the-type-system-is-your-friend/" target="_blank" rel="external">Johannes Weiß</a> 的谈话。Swift标准库也在使用幽灵类型，例如 <a href="https://developer.apple.com/reference/swift/unsafepointer" target="_blank" rel="external">UnsafePointer <memory></memory></a> 。</p>
<h2 id="好处"><a href="#好处" class="headerlink" title="好处"></a>好处</h2><p>我的方法最明显的好处是比使用度量值数据类型在大小上要小 50 % ，因为对单位实例的引用不是必要的。（单位实例自身是被所有那个单位的 Measurement 类所共用的，例如 5 米 和 10 米 两个度量值引用的是同一个单位实例。）但大小尺寸上的节省优势会被潜在更大的代码量所抵消，因为编译器会为泛型类型和使用该类型的函数产生更多的特化。</p>
<p>由于 Unit 在苹果的 API 中为引用类型，将测量值传给函数也会带来 retain 和 release 的开销。这两个因素对一个传统 App 来说都不是很重要，我也没有展开进一步的研究，在探索这些想法的时候，它们对我来说无关紧要。</p>
<h2 id="具体的设计"><a href="#具体的设计" class="headerlink" title="具体的设计"></a>具体的设计</h2><p>我们现在具体说一下如何在这个系统中定义单位，所有的单位都被封装到不同的单位族中，比如长度、温度、时长。我们开始为单位族定义一个协议：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">/// 表现为一种物理数值 或者 可以认为是 “ 单位之族 ”</div><div class="line">/// 例如: 长度， 温度， 速率.</div><div class="line">protocol UnitFamily &#123;</div><div class="line">associatedtype BaseUnit</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>正如苹果API中，每个单位族都会定义一个基础单位，它用于同一单位族的不同类型间的相互转换，例如长度单位族的基础单位是米。我们在 <code>UnitFamily</code> 协议中，把该基础单位定义为一个关联类型，这会有一个好处，基础单位会在这个类型系统中被编码，在 Foundation 库中，基础单位必须被单独记录以使得其他人用自定义的单位来扩展这个系统。</p>
<p>下一步是定义 <code>MyUnit</code> 协议以塑造具体的单位，这些单位在苹果的设计中会被定义为单位族类型的一个实例。（这里我使用 My 作为前缀来避免和苹果类型的命名冲突）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">/// 表现为度量值的单位</div><div class="line">/// 例如: 米， 公里， 英里， 秒， 小时， 摄氏度.</div><div class="line">protocol MyUnit &#123;</div><div class="line">associatedtype Family: UnitFamily</div><div class="line"></div><div class="line">static var symbol: String &#123; get &#125;</div><div class="line">static var converter: UnitConverter &#123; get &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>单位通过关联类型的方式来进行声明其所属的单位族。用静态属性来保存它的符号（比如米的符号是 m ，磅的符号是 lbs ）和它的单位转化器，转化器描述了如何将该单位转化为该族的基础单位。假如说长度单位族的基础单位是米，那么公里单位的转化器应该就是 <code>UnitConverterLinear(coefficient: 1000)</code>。基础单位自身的转化器系数应该为1。我这里从 Foundation 库中借用了<a href="https://developer.apple.com/reference/foundation/unitconverter" target="_blank" rel="external">UnitConverter</a> 类型。 Foundation 库将没有维度单位的 Unit 和有维度单位的 Dimension 进行了区分。简单起见，我们就不做这些事了，我们所有的单位都是有维度的。<br>基础单位也必须是一个单位类型，这样想当然没错，理想来说在 UnitFamily 协议中的 BaseUnit 应当有一个对应的基础单位约束，那就是 MyUnit 。不过遗憾的是，这样会使得两个协议之间产生循环引用，这样在Swift中肯定是不被许可的。话虽如此说，但即便没有约束，一切也能工作顺利。</p>
<h2 id="遵守协议"><a href="#遵守协议" class="headerlink" title="遵守协议"></a>遵守协议</h2><p>现在来为协议添加具体的实现。我这里展示一下长度、速度和时长的例子，每个都设置几个单位，再添加更多的单位和单位族也没什么意义。我选择用枚举来作为类型的结构，因为无例枚举不能被实例化，这对我们来说非常完美，因为我们只对类型感兴趣，而不是对类型的实例。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line">enum Length: UnitFamily &#123;</div><div class="line">typealias BaseUnit = Meters</div><div class="line">&#125;</div><div class="line"></div><div class="line">enum Meters: MyUnit &#123;</div><div class="line">typealias Family = Length</div><div class="line">static let symbol = &quot;m&quot;</div><div class="line">static let converter: UnitConverter = UnitConverterLinear(coefficient: 1)</div><div class="line">&#125;</div><div class="line"></div><div class="line">enum Kilometers: MyUnit &#123;</div><div class="line">typealias Family = Length</div><div class="line">static let symbol = &quot;km&quot;</div><div class="line">static let converter: UnitConverter = UnitConverterLinear(coefficient: 1000)</div><div class="line">&#125;</div><div class="line"></div><div class="line">// MARK: - Duration</div><div class="line">enum Duration: UnitFamily &#123;</div><div class="line">typealias BaseUnit = Seconds</div><div class="line">&#125;</div><div class="line"></div><div class="line">enum Seconds: MyUnit &#123;</div><div class="line">typealias Family = Duration</div><div class="line">static let symbol = &quot;s&quot;</div><div class="line">static let converter: UnitConverter = UnitConverterLinear(coefficient: 1)</div><div class="line">&#125;</div><div class="line"></div><div class="line">enum Minutes: MyUnit &#123;</div><div class="line">typealias Family = Duration</div><div class="line">static let symbol = &quot;min&quot;</div><div class="line">static let converter: UnitConverter = UnitConverterLinear(coefficient: 60)</div><div class="line">&#125;</div><div class="line"></div><div class="line">enum Hours: MyUnit &#123;</div><div class="line">typealias Family = Duration</div><div class="line">static let symbol = &quot;hr&quot;</div><div class="line">static let converter: UnitConverter = UnitConverterLinear(coefficient: 3600)</div><div class="line">&#125;</div><div class="line"></div><div class="line">// MARK: - Speed</div><div class="line">enum Speed: UnitFamily &#123;</div><div class="line">typealias BaseUnit = MetersPerSecond</div><div class="line">&#125;</div><div class="line"></div><div class="line">enum MetersPerSecond: MyUnit &#123;</div><div class="line">typealias Family = Speed</div><div class="line">static let symbol = &quot;m/s&quot;</div><div class="line">static let converter: UnitConverter = UnitConverterLinear(coefficient: 1)</div><div class="line">&#125;</div><div class="line"></div><div class="line">enum KilometersPerHour: MyUnit &#123;</div><div class="line">typealias Family = Speed</div><div class="line">static let symbol = &quot;km/h&quot;</div><div class="line">static let converter: UnitConverter = UnitConverterLinear(coefficient: 1.0/3.6)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="转换度量值"><a href="#转换度量值" class="headerlink" title="转换度量值"></a>转换度量值</h2><p>现在我们已经可以用不同的单位来表示度量值，接着我们需要让它们相互转换。<code>converted(to:)</code> 方法传入一个目标单位类型的参数并通过单位转换器返回那个单位新的度量值。注意这句约束<code>TargetUnit.Family == UnitType.Family</code>，它限制了转换只能适用于同单位族，编译器不会让你把<code>Meters</code>转换为<code>Seconds</code>。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">extension MyMeasurement &#123;</div><div class="line">/// Converts `self` to a measurement that has another unit of the same family.</div><div class="line">func converted&lt;TargetUnit&gt;(to target: TargetUnit.Type) -&gt; MyMeasurement&lt;TargetUnit&gt;</div><div class="line">where TargetUnit: MyUnit， TargetUnit.Family == UnitType.Family</div><div class="line">&#123;</div><div class="line">let valueInBaseUnit = UnitType.converter.baseUnitValue(fromValue: value)</div><div class="line">let valueInTargetUnit = TargetUnit.converter.value(fromBaseUnitValue: valueInBaseUnit)</div><div class="line">return MyMeasurement&lt;TargetUnit&gt;(valueInTargetUnit)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们来为 <code>MyMeasurement</code> 添加一些方便的功能，遵守<code>CustomStringConvertible</code>是一个输出调试的良好方案，并通过遵守 <code>ExpressibleByIntegerLiteral</code> 和 <code>ExpressibleByFloatLiteral</code> 协议使得通过字面量创建新的度量值变得更加轻松愉快。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">extension MyMeasurement: CustomStringConvertible &#123;</div><div class="line">var description: String &#123;</div><div class="line">return &quot;\(value) \(UnitType.symbol)&quot;</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">extension MyMeasurement: ExpressibleByIntegerLiteral &#123;</div><div class="line">init(integerLiteral value: IntegerLiteralType) &#123;</div><div class="line">self.value = Double(value)</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">extension MyMeasurement: ExpressibleByFloatLiteral &#123;</div><div class="line">init(floatLiteral value: FloatLiteralType) &#123;</div><div class="line">self.value = value</div><div class="line">&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="用法"><a href="#用法" class="headerlink" title="用法"></a>用法</h2><p>现在我们开始创造一些度量值并把它们转换为其他单位，应用字面量的语法来表达对象创建非常不错。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">let fiveMeters: MyMeasurement&lt;Meters&gt; = 5</div><div class="line">// → 5.0 m</div><div class="line">let threeKilometers: MyMeasurement&lt;Kilometers&gt; = 3</div><div class="line">// → 3.0 km</div><div class="line">threeKilometers.converted(to: Meters.self)</div><div class="line">// → 3000.0 m</div><div class="line">threeKilometers.converted(to: Seconds.self)</div><div class="line">// error: &apos;Family&apos; (aka &apos;Length&apos;) is not convertible to &apos;Family&apos; (aka &apos;Duration&apos;) (as expected)</div></pre></td></tr></table></figure>
<p>我们再来看看把度量值作为函数参数会怎么样？看一下这个假想的<code>delay</code>函数，它以时长和一个闭包作为参数，并在具体时长后执行闭包:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">func delay(after duration: MyMeasurement&lt;Seconds&gt;， block: () -&gt; ()) &#123;</div><div class="line">// ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这个函数需要以秒为单位的度量值，如果你传入了毫秒作为参数，你必须负责转化值。以 <code>TimeInterval</code> 作为参数可以具有类型安全的优势，编译器不会允许你传入 <code>MyMeasurement&lt;Milliseconds&gt;</code> 作参数，但这样做会比我们使用 <code>Measurement&lt;UnitDuration&gt;</code> 要大大降低灵活性，使用后者将会允许我们传入任意的时长单位。</p>
<p>我们通过基于单位类型将函数泛型化实现它(并且附上约束，它的单位族必须为时长)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">func delay&lt;Time&gt;(after duration: MyMeasurement&lt;Time&gt;， block: () -&gt; ())</div><div class="line">where Time: MyUnit， Time.Family == Duration</div><div class="line">&#123;</div><div class="line">// ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这种写法会有用，但会大大降低函数签名的可读性，即便是在<a href="https://github.com/apple/swift-evolution/blob/master/proposals/0081-move-where-expression.md" target="_blank" rel="external"> Where 子句的位置被转移</a>之后。</p>
<p>但就这一条理由来说，苹果将单位设为实例而不是类型的做法可能更为实用，更有意义。毕竟，米和公里只是同一东西的不同说法而已。但探索这个问题并不是很有意义，我们还是先继续。</p>
<h2 id="加法和标量乘法"><a href="#加法和标量乘法" class="headerlink" title="加法和标量乘法"></a>加法和标量乘法</h2><p>有时候我们需要把同样单位族的两个度量值作加法，即便他们有不同单位。通过使用泛型来重载 <code>+</code> 运算符方法就会容易，并且在习惯上我们会把右边的值转化为左边值得单位，并返回基于那个单位的结果。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">func + &lt;Unit1， Unit2&gt; (lhs: MyMeasurement&lt;Unit1&gt;， rhs: MyMeasurement&lt;Unit2&gt;) -&gt; MyMeasurement&lt;Unit1&gt;</div><div class="line">where Unit1: MyUnit， Unit2: MyUnit， Unit1.Family == Unit2.Family</div><div class="line">&#123;</div><div class="line">let rhsConverted = rhs.converted(to: Unit1.self)</div><div class="line">return MyMeasurement(lhs.value + rhsConverted.value)</div><div class="line">&#125;</div><div class="line"></div><div class="line">fiveMeters + threeKilometers</div><div class="line">// → 3005.0 m</div><div class="line">threeKilometers + fiveMeters</div><div class="line">// → 3.005 km</div></pre></td></tr></table></figure>
<p>我们再来注意一下这个约束 <code>Unit1.Family == Unit2.Family</code> ，它防止秒和米相加。</p>
<p>标量乘法就更容易实现了，因为没有单位转换参与。我们简单的把值相乘并创造一个新的度量值，两个重载方法被用于 <code>a * b</code> 和 <code>b * a</code> 两种情况。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">func * &lt;UnitType&gt; (measurement: MyMeasurement&lt;UnitType&gt;， scalar: Double) -&gt; MyMeasurement&lt;UnitType&gt; &#123;</div><div class="line">var result = measurement</div><div class="line">result.value *= scalar</div><div class="line">return result</div><div class="line">&#125;</div><div class="line"></div><div class="line">func * &lt;UnitType&gt; (scalar: Double， measurement: MyMeasurement&lt;UnitType&gt;) -&gt; MyMeasurement&lt;UnitType&gt; &#123;</div><div class="line">return measurement * scalar</div><div class="line">&#125;</div><div class="line"></div><div class="line">threeKilometers * 2</div><div class="line">// → 6.0 km</div><div class="line">let twoSeconds: MyMeasurement&lt;Seconds&gt; = 2</div><div class="line">60 * twoSeconds</div><div class="line">// → 120.0 s</div></pre></td></tr></table></figure>
<p>如果你记得这个系列的<a href="https://oleb.net/blog/2016/07/unitproduct/" target="_blank" rel="external">第二部分</a>，我最初的目的是想让单位之间可以被设计得相互依赖，例如  速度 = 路程 / 时间  或者 能量 = 功率 × 时间 。为了做到这些，我要介绍一个协议叫做 <code>UnitProduct</code>，通过遵守该协议和命名作为关联类型的因子，这样单位族可以表示其因子。</p>
<p>我们又做同样的事，但这次展示不同单位的关系而不是单位族。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">/// Describes this relation between units:</div><div class="line">/// Product = Factor1 * Factor2</div><div class="line">protocol Product: MyUnit &#123;</div><div class="line">associatedtype Factor1: MyUnit</div><div class="line">associatedtype Factor2: MyUnit</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>注意一下这样一个简单的协议足以描述乘法性和除法性关系，因为 <code>a = b × c</code> 等价于 <code>b = a / c</code>。选择结果是随意的，这样无论怎么选都会让这个关系看上去不自然。举例来说，假如我们想表示 速度 = 路程 / 时间，我们就得也把它重写为 路程 = 速度 × 时间 。<br>下一步来实现实际计算，即重载作用于遵守协议的类型的乘法和除法运算符方法。我们需要四个变量：<br><code>a = b × c</code><br>泛型约束让它看起来更加复杂了，对于任意遵守 <code>Product</code> 协议的 <code>Result</code> 类型，这个重载方法定义两个度量值的乘法，这两个度量值的单位 <code>Unit1</code> 和 <code>Unit2</code> 有着和 <code>Result</code>的 <code>Result.Factor1</code>和 <code>Result.Factor2</code>同样的单位族。而结果是通过将度量值各自转化为 <code>Result.Factor1</code> 和 <code>Result.Factor2</code> ，然后相乘。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">func * &lt;Unit1， Unit2， Result&gt; (lhs: MyMeasurement&lt;Unit1&gt;， rhs: MyMeasurement&lt;Unit2&gt;) -&gt; MyMeasurement&lt;Result&gt;</div><div class="line">where Result: Product， Result.Factor1.Family == Unit1.Family， Result.Factor2.Family == Unit2.Family</div><div class="line">&#123;</div><div class="line">let left = lhs.converted(to: Result.Factor1.self)</div><div class="line">let right = rhs.converted(to: Result.Factor2.self)</div><div class="line">return MyMeasurement(left.value * right.value)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>a = c × b</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">func * &lt;Unit1， Unit2， Result&gt; (lhs: MyMeasurement&lt;Unit2&gt;， rhs: MyMeasurement&lt;Unit1&gt;) -&gt; MyMeasurement&lt;Result&gt;</div><div class="line">where Result: Product， Result.Factor1.Family == Unit1.Family， Result.Factor2.Family == Unit2.Family</div><div class="line">&#123;</div><div class="line">return rhs * lhs</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这和先前的函数不完全类似，它将 lhs和 rhs 置换了。实现方式仅仅是转发给其他重载方法。</p>
<p><code>b = a / c   and  c = a / b</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">func / &lt;Unit1， Unit2， Result&gt; (lhs: MyMeasurement&lt;Result&gt;， rhs: MyMeasurement&lt;Unit2&gt;) -&gt; MyMeasurement&lt;Unit1&gt;</div><div class="line">where Result: Product， Result.Factor1.Family == Unit1.Family， Result.Factor2.Family == Unit2.Family</div><div class="line">&#123;</div><div class="line">let right = rhs.converted(to: Result.Factor2.self)</div><div class="line">return MyMeasurement(lhs.value / right.value)</div><div class="line">&#125;</div><div class="line"></div><div class="line">func / &lt;Unit1， Unit2， Result&gt; (lhs: MyMeasurement&lt;Result&gt;， rhs: MyMeasurement&lt;Unit1&gt;) -&gt; MyMeasurement&lt;Unit2&gt;</div><div class="line">where Result: Product， Result.Factor1.Family == Unit1.Family， Result.Factor2.Family == Unit2.Family</div><div class="line">&#123;</div><div class="line">let right = rhs.converted(to: Result.Factor1.self)</div><div class="line">return MyMeasurement(lhs.value / right.value)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>同样的方式，不过泛型参数的位置发生了变化。</p>
<h2 id="具体实现"><a href="#具体实现" class="headerlink" title="具体实现"></a>具体实现</h2><p>现在它终于可以表示关系 路程 = 速度 × 时间（即 速度 = 路程 / 时间）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">extension Meters: Product &#123;</div><div class="line">typealias Factor1 = MetersPerSecond</div><div class="line">typealias Factor2 = Seconds</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>它可以这样用:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">let tenMeters: MyMeasurement&lt;Meters&gt; = 10</div><div class="line">let fourSeconds: MyMeasurement&lt;Seconds&gt; = 4</div><div class="line">let speed: MyMeasurement&lt;MetersPerSecond&gt; = tenMeters / fourSeconds</div><div class="line">// → 2.5 m/s</div><div class="line"></div><div class="line">let thirtyKilometersPerHour: MyMeasurement&lt;KilometersPerHour&gt; = 30</div><div class="line">let twoHours: MyMeasurement&lt;Hours&gt; = 2</div><div class="line">let tripLength: MyMeasurement&lt;Meters&gt; = thirtyKilometersPerHour * twoHours</div><div class="line">// → 60000.0 m</div><div class="line">tripLength.converted(to: Kilometers.self)</div><div class="line">// → 60.0 km</div></pre></td></tr></table></figure>
<p>它的工作效果不错，但是有两个明显的缺点。第一个是目前的编译器无法推断出自动计算的返回类型，我不知道是否今后的编译器可以解决这个问题，也许我可以通过在函数中设置更好的泛型约束的方式提供一些帮助，但是尝试之后，依然没能解决问题。<br>第二点是参数的单位需要有正确的单位族，返回类型的单位会被使用 <code>Product</code> 协议的具体单位所限制。因此类似 <code>let tripLength: MyMeasurement&lt;Kilometers&gt; = ...</code> 并不会起作用，你必须先提供以米形式的结果，然后再把它转换。这是一个非常大的限制。</p>
<h2 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h2><p>忽略这个设计的缺陷（确实存在），你得注意不止一行可执行代码需要为类型系统增加数学关系！仅仅通过添加协议一致（即定义两个关联类型），我们就可以从字面上把任务 1 meter = 1 m/s × 1 s 添加给编译器的“真理”池。但如果你要添加其他数学关系（比如1 J = 1 W × 1 s），那么我们就必须再添加一个协议一致。<br>我觉得这种写法非常吸引我。但尽管如此，我不认为这个基于幽灵类型的 API 优于苹果基础库中的 API，基于单位族而不是单位的度量值其实只会更加有意义。</p>

	
	
	
	
</div>
				
				

                <!-- Post Comments -->
                
    <!-- 使用多说评论 -->
    <link rel="stylesheet" href="/css/duoshuo.min.css">
<style>
    #ds-thread #ds-reset .ds-post-button{
        background-color: #FF8247 !important;
    }
    #ds-wrapper #ds-reset .ds-icons-32{
        background-color: #FF8247 !important;
    }
    #ds-reset .ds-highlight {
        color: #FF8247 !important;
    }
</style>
<div id="comments">
    <!-- 多说评论框 start -->
        <div class="ds-thread" data-thread-key="undefined" data-title="[译]使用幽灵类型的Measurements和Units ，第四部分" data-url="http://chenmingjia.github.io//2016/10/18/unitsquare/index.html"></div>
    <!-- 多说评论框 end -->
</div>



            </div>

            <!-- Post Prev & Next Nav -->
            <nav class="material-nav mdl-color-text--grey-50 mdl-cell mdl-cell--12-col">
    
    <!-- Prev Nav -->
    
        <a href="/2016/11/10/unitsquare/" id="post_nav-newer" class="prev-content">
            <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                <i class="material-icons">arrow_back</i>
            </button>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            新篇
        </a>
    

    <!-- Section Spacer -->
    <div class="section-spacer"></div>

    <!-- Next Nav -->
    
</nav>
        </div>
    </div>

				
				
					<!-- Overlay For Active Sidebar -->
<div class="sidebar-overlay "></div>

<!-- Material sidebar -->
<aside id="sidebar" class="sidebar sidebar-colored  sidebar-fixed-left" role="navigation">
	<div id="sidebar-main">
	    <!-- Sidebar Header -->
		<div class="sidebar-header header-cover" style="background-image: url(/img/sidebar_header.png);">
    <!-- Top bar -->
    <div class="top-bar"></div>

    <!-- Sidebar toggle button -->
    <button type="button" class="sidebar-toggle mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon" style="display: initial;" data-upgraded=",MaterialButton,MaterialRipple">
    <i class="material-icons">clear_all</i>
    <span class="mdl-button__ripple-container"><span class="mdl-ripple"></span></span></button>

    <!-- Sidebar Avatar -->
    <div class="sidebar-image">
        <img src="/img/avatar.png" alt="与狼同行's avatar">
    </div>

    <!-- Sidebar Email -->
    <a data-toggle="dropdown" class="sidebar-brand" href="#settings-dropdown">
        youremail@email.com
        <b class="caret"></b>
    </a>
</div>

		<!-- Sidebar Navigation  -->
		<ul class="nav sidebar-nav">
    <!-- User dropdown  -->
    <li class="dropdown">
        <ul id="settings-dropdown" class="dropdown-menu">
			
                <li>
                    <a href="#" target="_blank" title="Email Me">
						<i class="material-icons sidebar-material-icons sidebar-indent-left1pc-element">email</i>
                        Email Me
                    </a>
                </li>
            
        </ul>
    </li>

    <!-- Homepage -->
    <li id="sidebar-first-li">
        <a href="/" target="_self">
            <i class="material-icons sidebar-material-icons">home</i>
             主页
        </a>
    </li>

    <!-- I'm Feeling Lucky -->
<!--
    <li class="dropdown">
        <a href="" target="_self">
            <i class="material-icons sidebar-material-icons">explore</i>
             sidebar.imlucky
        </a>
    </li>
-->

	
    <!-- Archives  -->
    <li class="dropdown">
        <a href="#" class="ripple-effect dropdown-toggle" data-toggle="dropdown">
            <i class="material-icons sidebar-material-icons">inbox</i>
             归档
            <b class="caret"></b>
        </a>
        <ul class="dropdown-menu">
            <li>
            <a class="sidebar_archives-link" href="/archives/2016/11/">十一月 2016<span class="sidebar_archives-count">17</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/10/">十月 2016<span class="sidebar_archives-count">1</span></a>
        </ul>
    </li>

    <!-- Divider -->
    <li class="divider"></li>


    <!-- Pages  -->
	
	
	
		<li>
			<a href="/about" title="关于博主">
				关于博主
			</a>
		</li>
	
		<li>
			<a href="/links/" title="友情链接">
				友情链接
			</a>
		</li>
	
		<li>
			<a href="/timeline/" title="时间轴归档">
				时间轴归档
			</a>
		</li>
	
		<li>
			<a href="/gallery/" title="图库">
				图库
			</a>
		</li>
	
		<li>
			<a href="/tags/" title="标签云">
				标签云
			</a>
		</li>
	

    <!-- Article Numebr  -->
    <li>
        <a href="#">
             文章总数
             <span class="sidebar-badge">18</span>
        </a>
    </li>
</ul>

		<!-- Sidebar Divider -->
		<div class="sidebar-divider"></div>

		<!-- Sidebar Footer -->
		<!-- 
I'm glad you use this theme, the development is no so easy, I hope you can keep the copyright, I will thank you so much.
If you still want to delete the copyrights, could you still retain the first one? Which namely "Theme Material"
It will not impact the appearance and can give developers a lot of support :)

很高兴您使用并喜欢该主题，开发不易 十分谢谢与希望您可以保留一下版权声明。
如果您仍然想删除的话 能否只保留第一项呢？即 "Theme Material"
它不会影响美观并可以给开发者很大的支持。 :) 
-->

<!-- Theme Material -->
<a href="https://github.com/viosey/hexo-theme-material"  class="sidebar-footer-text-a" target="_blank">
	<div class="sidebar-text mdl-button mdl-js-button mdl-js-ripple-effect sidebar-footer-text-div" data-upgraded=",MaterialButton,MaterialRipple">
		主题 - Material
		<span class="sidebar-badge badge-circle">i</span>
	</div>
</a>

<!-- Help & Support -->
<!--
<a href="mailto:hiviosey@gmail.com" class="sidebar-footer-text-a">
    <div class="sidebar-text mdl-button mdl-js-button mdl-js-ripple-effect sidebar-footer-text-div" data-upgraded=",MaterialButton,MaterialRipple">
		sidebar.help
		<span class="mdl-button__ripple-container">
			<span class="mdl-ripple"></span>
		</span>
	</div>
</a>
-->

<!-- Feedback -->
<!--
<a href="https://github.com/viosey/hexo-theme-material/issues" target="_blank" class="sidebar-footer-text-a">
    <div class="sidebar-text mdl-button mdl-js-button mdl-js-ripple-effect sidebar-footer-text-div" data-upgraded=",MaterialButton,MaterialRipple">
         sidebar.feedback
                    <span class="mdl-button__ripple-container"><span class="mdl-ripple"></span></span></div>
</a>
-->

<!-- Abount Theme -->
<!--
<a href="https://blog.viosey.com/index.php/Material.html" target="_blank" class="sidebar-footer-text-a">
    <div class="sidebar-text mdl-button mdl-js-button mdl-js-ripple-effect sidebar-footer-text-div" data-upgraded=",MaterialButton,MaterialRipple">
         sidebar.about_theme
        <span class="mdl-button__ripple-container"><span class="mdl-ripple"></span></span></div>
</a>-->

	</div>
    
    <!-- Sidebar Sponsor -->
    


</aside>

				
				
				<!-- Floating Action Button -->
<div class="fabs">
    <a href="#top" class="fab toTop">
        <i class="material-icons">expand_less</i>
    </a>
    
    
        <!-- Post Nav -->
        
            <a class="prev-content fab" href="/2016/11/10/unitsquare/" title="[iOS]Instagram/IGListKit实践谈"><i class="material-icons">keyboard_arrow_left</i></a>
        

        
    
    
    
    
    <a href="#bottom" class="fab toBottom">
        <i class="material-icons">keyboard_arrow_down</i>
    </a>
    
    <a id="prime" class="fab">
        <i class="material-icons prime-i-add">add</i>
    </a>
</div>
				
				<!--Footer-->
<footer class="mdl-mini-footer" id="bottom">
	
	
		<!-- Paradox Footer Left Section -->
		<div class="mdl-mini-footer--left-section sns-list">
    <!-- Twitter -->
    
    
    
    <!-- Facebook -->
    
    
    
    <!-- Google + -->
    
    
    
    <!-- Weibo -->
    
    
    
    <!-- Instagram -->
    
    
    
    <!-- Tumblr -->
    
    
    
    <!-- Github -->
    
    <a href="https://www.github.com/chenmingjia" target="view_window"><button class="mdl-mini-footer--social-btn social-btn" style="background-image: url(/img/footer/footer_ico-github.png);">
        <span class="visuallyhidden">Github</span>
    </button></a>
    
</div>


		<!--Copyright-->
		<div id="copyright">Copyright&nbsp;©&nbsp;<script type="text/javascript">var fd = new Date();document.write(fd.getFullYear());</script>&nbsp;Big Wolf’s Blog</div>

		<!-- Paradox Footer Right Section -->

		<!-- 
		I'm glad you use this theme, the development is no so easy, I hope you can keep the copyright.
		It will not impact the appearance and can give developers a lot of support :)

		很高兴您使用该主题，开发不易，希望您可以保留一下版权声明。
		它不会影响美观并可以给开发者很大的支持。 :) 
		-->

		<div class="mdl-mini-footer--right-section">
			<div>
				<div class="footer-develop-div">Powered by <a href="https://hexo.io" target="_blank" class="footer-develop-a">Hexo</a></div>
				<div class="footer-develop-div">Theme - <a href="https://github.com/viosey/hexo-theme-material" target="_blank" class="footer-develop-a">Material</a></div>
			</div>
		</div>
	
    
</footer>
                
				<!-- Import File -->
<script src="/js/js.min.js"></script>
<script src="/js/nprogress.js"></script>

<script type="text/javascript">
    NProgress.configure({
        showSpinner: true
    });
    NProgress.start();
    
    $('#nprogress .bar').css({
        'background': '#FF8247'
    });
    $('#nprogress .peg').css({
        'box-shadow': '0 0 10px #FF8247, 0 0 15px #FF8247'
    });
    $('#nprogress .spinner-icon').css({
        'border-top-color': '#FF8247',
        'border-left-color': '#FF8247'
    });
    
    setTimeout(function() {
        NProgress.done();
        $('.fade').removeClass('out');
    }, 800);
</script>








    <!-- 多说公共 js 代码 start -->
    <script type="text/javascript">
    var duoshuoQuery = {short_name:"2231132"};
        (function() {
            var ds = document.createElement('script');
            ds.type = 'text/javascript';ds.async = true;
            ds.src = 'https://static.duoshuo.com/embed.js';
            ds.charset = 'UTF-8';
            (document.getElementsByTagName('head')[0] 
             || document.getElementsByTagName('body')[0]).appendChild(ds);
        })();
    </script>
    <!-- 多说公共 js 代码 end -->







	<script>
	var searchFunc = function(path, search_id, content_id) {
    'use strict';
    $.ajax({
        url: path,
        dataType: "xml",
        success: function( xmlResponse ) {
            // get the contents from search data
            var datas = $( "entry", xmlResponse ).map(function() {
                return {
                    title: $( "title", this ).text(),
                    content: $("content",this).text(),
                    url: $( "url" , this).text()
                };
            }).get();
            var $input = document.getElementById(search_id);
            var $resultContent = document.getElementById(content_id);
            $input.addEventListener('input', function(){
                var str='<ul class=\"search-result-list\">';                
                var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                $resultContent.innerHTML = "";
                if (this.value.trim().length <= 0) {
                    return;
                }
                // perform local searching
                datas.forEach(function(data) {
                    var isMatch = true;
                    var content_index = [];
                    var data_title = data.title.trim().toLowerCase();
                    var data_content = data.content.trim().replace(/<[^>]+>/g,"").toLowerCase();
                    var data_url = data.url;
                    var index_title = -1;
                    var index_content = -1;
                    var first_occur = -1;
                    // only match artiles with not empty titles and contents
                    if(data_title != '' && data_content != '') {
                        keywords.forEach(function(keyword, i) {
                            index_title = data_title.indexOf(keyword);
                            index_content = data_content.indexOf(keyword);
                            if( index_title < 0 && index_content < 0 ){
                                isMatch = false;
                            } else {
                                if (index_content < 0) {
                                    index_content = 0;
                                }
                                if (i == 0) {
                                    first_occur = index_content;
                                }
                            }
                        });
                    }
                    // show search results
                    if (isMatch) {
                        str += "<li><a href='"+ data_url +"' class='search-result-title' target='_blank'>"+ data_title;
                        var content = data.content.trim().replace(/<[^>]+>/g,"");
                        if (first_occur >= 0) {
                            // cut out characters
                            var start = first_occur - 6;
                            var end = first_occur + 6;
                            if(start < 0){
                                start = 0;
                            }
                            if(start == 0){
                                end = 10;
                            }
                            if(end > content.length){
                                end = content.length;
                            }
                            var match_content = content.substr(start, end); 
                            // highlight all keywords
                            keywords.forEach(function(keyword){
                                var regS = new RegExp(keyword, "gi");
                                match_content = match_content.replace(regS, "<em class=\"search-keyword\">"+keyword+"</em>");
                            })
                            str += "<p class=\"search-result\">" + match_content +"...</p>" +"</a>";
                        }
                    }
                })
                $resultContent.innerHTML = str;
            })
        }
    })
}
</script>

	<script>
		var search_path = "search.xml";
		if (search_path.length == 0) {
		search_path = "search.xml";
		}
		var path = "/" + search_path;
		searchFunc(path, 'search', 'local-search-result');
	</script>






            </main>
        </div>
		
    </body>
		
	
</html>
